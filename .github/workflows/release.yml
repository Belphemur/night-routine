name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write # Required for attestations
  attestations: write # Required for attestations

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3 # Use an official action

      # Removed CycloneDX install step as GoReleaser's built-in SBOM generation is used

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Install cross-compilers
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Export Digest
        id: digest
        run: |
          mkdir -p /tmp/digests
          # Extract digest for the multi-arch manifest
          MANIFEST_TAG="ghcr.io/belphemur/night-routine:${{ github.ref_name }}" # Use github.ref_name for version
          echo "Inspecting manifest: $MANIFEST_TAG"
          DIGEST=$(docker buildx imagetools inspect $MANIFEST_TAG --format "{{json .Manifest.Digest}}" | xargs)
          echo "Found digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "${{ github.ref_name }}@sha256:$DIGEST" > "/tmp/digests/${{ github.ref_name }}" # Use github.ref_name for version

      - name: Attest
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "ghcr.io/belphemur/night-routine:${{ github.ref_name }}" # Use github.ref_name for version
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: true
