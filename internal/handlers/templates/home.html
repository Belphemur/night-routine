{{define "title"}}Night Routine - Home{{end}}

{{define "content"}}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Dashboard</h2>
    <p class="text-slate-600 text-lg">Manage your family's night routine schedule</p>
</div>

<!-- Alerts -->
{{if .ErrorMessage}}
<div class="bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚ö†Ô∏è</span>
    <div>
        <strong class="font-bold block mb-1">Error</strong>
        <span>{{.ErrorMessage}}</span>
    </div>
</div>
{{end}}

{{if .SuccessMessage}}
<div class="bg-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚úì</span>
    <div>
        <strong class="font-bold block mb-1">Success</strong>
        <span>{{.SuccessMessage}}</span>
    </div>
</div>
{{end}}

<!-- Connection Status Card -->
<div
    class="bg-white rounded-2xl shadow-xl p-8 mb-8 border {{if .IsAuthenticated}}border-emerald-200{{else}}border-rose-200{{end}}">
    {{if .IsAuthenticated}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-emerald-100 rounded-full p-3">
            <span class="text-3xl">‚úì</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Connected</h2>
            <p class="text-slate-600">Google Calendar is active</p>
        </div>
    </div>
    {{if .CalendarID}}
    <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <p class="text-sm text-slate-600 mb-1">Active Calendar</p>
        {{if .CalendarName}}
        <p class="text-slate-900 font-medium text-lg">{{.CalendarName}}</p>
        <p class="text-slate-500 text-sm break-all">{{.CalendarID}}</p>
        {{else}}
        <p class="text-slate-900 font-medium break-all">{{.CalendarID}}</p>
        {{end}}
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a href="/calendars"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üìÖ Change Calendar
        </a>
        <button type="button" id="sync-btn"
            class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üîÑ Sync Now
        </button>
    </div>
    {{else}}
    <p class="text-slate-700 mb-6">No calendar selected yet</p>
    <a href="/calendars"
        class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üìÖ Select Calendar
    </a>
    {{end}}
    {{else}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-rose-100 rounded-full p-3">
            <span class="text-3xl">‚úó</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Not Connected</h2>
            <p class="text-slate-600">Connect to get started</p>
        </div>
    </div>
    <p class="text-slate-700 mb-6">Link your Google Calendar to begin managing your night routine schedule</p>
    <a href="/auth"
        class="inline-block bg-linear-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üîó Connect Google Calendar
    </a>
    {{end}}
</div>

<!-- Calendar Section -->
{{if and .IsAuthenticated .CalendarWeeks}}
<!-- Desktop Calendar View (Full Month) - Hidden on mobile -->
<div class="hidden md:block bg-white rounded-2xl shadow-xl p-6 md:p-8">
    <div class="mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">üìÖ {{.CurrentMonth}}</h2>
        <p class="text-slate-600">Your night routine assignments</p>
    </div>
    <div class="overflow-x-auto -mx-6 md:-mx-8 px-6 md:px-8">
        <table class="w-full border-collapse min-w-full" id="assignment-calendar" role="table" aria-label="Monthly calendar of night routine assignments">
            <caption class="sr-only">{{.CurrentMonth}} night routine assignment calendar</caption>
            <thead>
                <tr>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tl-xl">
                        Mon</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Tue</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Wed</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Thu</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Fri</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Sat</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tr-xl">
                        Sun</th>
                </tr>
            </thead>
            <tbody>
                {{range .CalendarWeeks}}
                <tr>
                    {{range .}}
                    <td class="border border-slate-200 p-3 text-center align-top h-24 md:h-28 relative cursor-pointer transition-all duration-200
                            {{if not .IsCurrentMonth}}bg-slate-50 text-slate-400{{else}}bg-white hover:shadow-lg{{end}}
                            {{if .Assignment}}
                                {{if eq .Assignment.ParentType.String "ParentA"}}bg-linear-to-br from-blue-50 to-indigo-100 text-indigo-900 border-indigo-200 hover:from-blue-100 hover:to-indigo-200{{end}}
                                {{if eq .Assignment.ParentType.String "ParentB"}}bg-linear-to-br from-amber-50 to-orange-100 text-orange-900 border-orange-200 hover:from-amber-100 hover:to-orange-200{{end}}
                                {{if eq .Assignment.DecisionReason "Override"}}overridden{{end}}
                            {{end}}" 
                        data-date="{{.Date.Format "2006-01-02"}}" 
                        {{if .Assignment}}data-assignment-id="{{.Assignment.ID}}"{{end}}
                        aria-label="{{.Date.Format "January 2, 2006"}}{{if .Assignment}} - {{.Assignment.Parent}} assigned{{if eq .Assignment.DecisionReason "Override"}} - Locked (manually overridden){{end}}{{end}}">
                        <span class="block text-lg md:text-xl font-bold mb-1">{{.DayOfMonth}}</span>
                        {{if .Assignment}}
                        <span class="block text-xs md:text-sm font-semibold">{{.Assignment.Parent}}</span>
                        {{if .Assignment.DecisionReason}}
                        <span class="block text-xs text-slate-500 mt-1">{{.Assignment.DecisionReason}}</span>
                        {{end}}
                        {{end}}
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<!-- Mobile Calendar View (Weekly) - Visible only on mobile -->
<div class="block md:hidden bg-white rounded-2xl shadow-xl p-4">
    <div class="mb-4">
        <h2 class="text-xl font-bold text-slate-900 mb-2">üìÖ <span id="mobile-week-label">{{.CurrentMonth}}</span></h2>
        <p class="text-slate-600 text-sm">Your night routine assignments</p>
    </div>
    
    <!-- Week Navigation -->
    <div class="flex items-center justify-between mb-4 gap-2">
        <button id="prev-week-btn" 
            aria-label="Go to previous week"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span aria-hidden="true">‚Üê</span>
            <span>Previous</span>
        </button>
        <button id="current-week-btn"
            aria-label="Go to current week"
            class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg transition-all duration-200 hover:shadow-lg text-sm">
            Today
        </button>
        <button id="next-week-btn"
            aria-label="Go to next week"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span>Next</span>
            <span aria-hidden="true">‚Üí</span>
        </button>
    </div>

    <!-- Weekly Calendar Tables (split into 2 rows for mobile) -->
    <div role="region" aria-label="Weekly calendar view">
        <!-- First row: Mon-Thu -->
        <table class="w-full border-collapse mb-2" id="mobile-assignment-calendar-row1" role="table" aria-label="Monday through Thursday assignments">
            <caption class="sr-only">Monday through Thursday night routine assignments</caption>
            <thead>
                <tr>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Mon</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Tue</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Wed</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Thu</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row1">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
        
        <!-- Second row: Fri-Sun -->
        <table class="w-full border-collapse" id="mobile-assignment-calendar-row2" role="table" aria-label="Friday through Sunday assignments">
            <caption class="sr-only">Friday through Sunday night routine assignments</caption>
            <thead>
                <tr>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Fri</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Sat</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Sun</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row2">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>
{{end}}
<!-- End Calendar Section -->

<!-- Unlock Modal -->
<div id="unlock-modal" class="relative z-10 hidden" aria-labelledby="unlock-modal-title" role="dialog" aria-modal="true">
    <div id="unlock-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="unlock-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-lg">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="unlock-modal-title">Unlock Event</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">
                            This event will be re-evaluated by the scheduler. Are you sure you want to unlock this assignment?
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="unlock-modal-confirm"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:ml-3 sm:w-auto">
                    Unlock Event
                </button>
                <button type="button" id="unlock-modal-cancel"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 sm:mt-0 sm:w-auto">
                    Cancel
                </button>
            </div>
        </div>
      </div>
    </div>
</div>

<!-- Assignment Details Modal -->
<div id="details-modal" class="relative z-10 hidden" aria-labelledby="details-modal-title" role="dialog" aria-modal="true">
    <div id="details-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="details-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-lg">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="details-modal-title">Assignment Details</h3>
                    <div class="mt-4" id="details-modal-content">
                        <p class="text-sm text-gray-500">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="details-modal-close"
                    class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-indigo-600 sm:w-auto">
                    Close
                </button>
            </div>
        </div>
      </div>
    </div>
</div>

<!-- Sync Loading Modal -->
<div id="sync-modal" class="relative z-10 hidden" aria-labelledby="sync-modal-title" role="dialog" aria-modal="true">
    <div id="sync-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="sync-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-sm">
            <div class="text-center">
                <!-- Loading State -->
                <div id="sync-loading" class="block">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 mb-4">
                        <svg class="h-6 w-6 text-emerald-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="sync-modal-title">Syncing Calendar</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">Please wait while we sync your schedule with Google Calendar...</p>
                    </div>
                </div>
                <!-- Success State -->
                <div id="sync-success" class="hidden">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 mb-4">
                        <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Sync Complete!</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="sync-success-message">Your schedule has been synced successfully.</p>
                    </div>
                </div>
                <!-- Error State -->
                <div id="sync-error" class="hidden">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Sync Failed</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="sync-error-message">An error occurred while syncing.</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 hidden" id="sync-modal-close-container">
                <button type="button" id="sync-modal-close"
                    class="inline-flex w-full justify-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-emerald-600">
                    Close
                </button>
            </div>
        </div>
      </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to format date as YYYY-MM-DD (local timezone)
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const todayString = getLocalDateString(today);
        const todayCell = document.querySelector(`#assignment-calendar td[data-date="${todayString}"]`);

        if (todayCell) {
            // Add custom today-cell class for styling
            todayCell.classList.add('today-cell');
        }

        // Calendar interaction management
        const calendar = document.getElementById('assignment-calendar');
        if (calendar) {
            // Handle clicks on calendar
            calendar.addEventListener('click', function (e) {
                const cell = e.target.closest('td[data-assignment-id]');

                if (!cell) return;

                e.stopPropagation();
                const assignmentId = cell.dataset.assignmentId;
                
                // Check if this is an overridden cell (has priority)
                if (cell.classList.contains('overridden')) {
                    if (assignmentId) {
                        showUnlockModal(assignmentId);
                    }
                } else {
                    // Show details modal for non-overridden assignments
                    if (assignmentId) {
                        showDetailsModal(assignmentId);
                    }
                }
            });
        }

        // Mobile Weekly Calendar Logic
        // Tailwind CSS classes used dynamically in JavaScript - DO NOT REMOVE
        // Classes: h-24 p-2 text-xs text-lg block font-bold mb-1 font-semibold text-slate-500 mt-1
        const mobileCalendarRow1 = document.getElementById('mobile-assignment-calendar-row1');
        const mobileCalendarRow2 = document.getElementById('mobile-assignment-calendar-row2');
        if (mobileCalendarRow1 && mobileCalendarRow2) {
            let currentWeekOffset = 0;
            
            // Use calendar data provided by the server as JSON
            const mobileData = {{.CalendarData | js}};
            const calendarData = mobileData.days || [];
            const startDateStr = mobileData.startDate;
            const endDateStr = mobileData.endDate;
            
            const allDays = calendarData.map(day => ({
                date: new Date(day.dateStr + 'T00:00:00'),
                dateStr: day.dateStr,
                dayOfMonth: day.dayOfMonth,
                assignmentId: day.assignmentId || null,
                assignmentParent: day.assignmentParent || '',
                assignmentReason: day.assignmentReason || '',
                isOverridden: day.isOverridden || false,
                classes: day.cssClasses || ''
            }));
            
            // Create a Map for O(1) lookups by date string
            const allDaysMap = new Map(allDays.map(day => [day.dateStr, day]));

            function getMondayOfWeek(date) {
                // Create a completely independent copy using timestamp
                const d = new Date(date.getTime());
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                d.setDate(diff);
                return d;
            }

            function formatWeekLabel(mondayDate) {
                const sunday = new Date(mondayDate.getTime());
                sunday.setDate(sunday.getDate() + 6);
                
                const options = { month: 'long', day: 'numeric' };
                const mondayStr = mondayDate.toLocaleDateString('en-US', options);
                const sundayStr = sunday.toLocaleDateString('en-US', { ...options, year: 'numeric' });
                
                if (mondayDate.getMonth() === sunday.getMonth()) {
                    return `Week of ${mondayStr} - ${sunday.getDate()}, ${sunday.getFullYear()}`;
                }
                return `Week of ${mondayStr} - ${sundayStr}`;
            }

            function renderWeek() {
                const mondayOfTargetWeek = getMondayOfWeek(today);
                mondayOfTargetWeek.setDate(mondayOfTargetWeek.getDate() + (currentWeekOffset * 7));
                
                // Update week label
                const weekLabel = formatWeekLabel(mondayOfTargetWeek);
                document.getElementById('mobile-week-label').textContent = weekLabel;

                // Get the 7 days for this week
                const weekDays = [];
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(mondayOfTargetWeek);
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateStr = getLocalDateString(currentDate);
                    
                    // Find matching day using Map for O(1) lookup
                    const dayData = allDaysMap.get(dateStr);
                    
                    // Default classes for days without data
                    const defaultClasses = 'border border-slate-200 p-2 text-center align-top h-20 relative bg-white';
                    
                    weekDays.push(dayData || {
                        date: currentDate,
                        dateStr: dateStr,
                        dayOfMonth: currentDate.getDate(),
                        assignmentId: null,
                        assignmentParent: '',
                        assignmentReason: '',
                        isOverridden: false,
                        classes: defaultClasses
                    });
                }

                // Render the week - split into two rows
                const tbody1 = document.getElementById('mobile-calendar-body-row1');
                const tbody2 = document.getElementById('mobile-calendar-body-row2');
                tbody1.replaceChildren();
                tbody2.replaceChildren();
                
                // Helper function to create a day cell
                function createDayCell(day) {
                    const td = document.createElement('td');
                    // Combine classes reliably with array filtering
                    td.className = [day.classes, 'h-24', 'p-2', 'text-xs'].filter(Boolean).join(' ');
                    td.setAttribute('data-date', day.dateStr);
                    if (day.assignmentId) {
                        td.setAttribute('data-assignment-id', day.assignmentId);
                    }

                    // Build aria-label for accessibility
                    const dateObj = new Date(day.dateStr + 'T00:00:00');
                    let ariaLabel = dateObj.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    if (day.assignmentParent) {
                        ariaLabel += ` - ${day.assignmentParent} assigned`;
                        if (day.isOverridden) {
                            ariaLabel += ' - Locked (manually overridden)';
                        }
                    }
                    td.setAttribute('aria-label', ariaLabel);

                    // Check if this is today
                    if (day.dateStr === todayString) {
                        td.classList.add('today-cell');
                    }

                    // Create elements safely without innerHTML to avoid XSS
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'block text-lg font-bold mb-1';
                    dayNumber.textContent = day.dayOfMonth;
                    td.appendChild(dayNumber);

                    if (day.assignmentParent) {
                        const parentSpan = document.createElement('span');
                        parentSpan.className = 'block text-xs font-semibold';
                        parentSpan.textContent = day.assignmentParent;
                        td.appendChild(parentSpan);
                    }

                    if (day.assignmentReason) {
                        const reasonSpan = document.createElement('span');
                        reasonSpan.className = 'block text-xs text-slate-500 mt-1';
                        reasonSpan.textContent = day.assignmentReason;
                        td.appendChild(reasonSpan);
                    }
                    return td;
                }
                
                // First row: Mon-Thu (days 0-3)
                const row1 = document.createElement('tr');
                for (let i = 0; i < 4; i++) {
                    row1.appendChild(createDayCell(weekDays[i]));
                }
                tbody1.appendChild(row1);
                
                // Second row: Fri-Sun (days 4-6)
                const row2 = document.createElement('tr');
                for (let i = 4; i < 7; i++) {
                    row2.appendChild(createDayCell(weekDays[i]));
                }
                tbody2.appendChild(row2);

                // Add click handlers for overridden cells in both tables
                [tbody1, tbody2].forEach(tbody => {
                    tbody.querySelectorAll('td[data-assignment-id]').forEach(cell => {
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const assignmentId = this.getAttribute('data-assignment-id');
                            if (assignmentId) {
                                // Check if overridden
                                if (this.classList.contains('overridden')) {
                                    showUnlockModal(assignmentId);
                                } else {
                                    showDetailsModal(assignmentId);
                                }
                            }
                        });
                    });
                });

                // Update button states based on data availability
                const prevBtn = document.getElementById('prev-week-btn');
                const nextBtn = document.getElementById('next-week-btn');

                const updateButtonState = (button, enabled) => {
                    button.disabled = !enabled;
                    button.classList.toggle('opacity-50', !enabled);
                    button.classList.toggle('cursor-not-allowed', !enabled);
                    button.classList.toggle('hover:bg-indigo-600', enabled);
                    button.classList.toggle('hover:shadow-lg', enabled);
                };
                
                // Check if previous week is within range
                // We check if the Monday of the previous week is >= startDate
                const prevWeekMonday = new Date(mondayOfTargetWeek);
                prevWeekMonday.setDate(prevWeekMonday.getDate() - 7);
                const prevWeekMondayStr = getLocalDateString(prevWeekMonday);
                
                // Simple string comparison works for YYYY-MM-DD
                const canGoBack = startDateStr && prevWeekMondayStr >= startDateStr;
                updateButtonState(prevBtn, canGoBack);

                // Check if next week is within range
                // We check if the Sunday of the next week is <= endDate
                const nextWeekMonday = new Date(mondayOfTargetWeek);
                nextWeekMonday.setDate(nextWeekMonday.getDate() + 7);
                const nextWeekSunday = new Date(nextWeekMonday);
                nextWeekSunday.setDate(nextWeekSunday.getDate() + 6);
                const nextWeekSundayStr = getLocalDateString(nextWeekSunday);
                
                const canGoForward = endDateStr && nextWeekSundayStr <= endDateStr;
                updateButtonState(nextBtn, canGoForward);
            }

            // Navigation button handlers
            document.getElementById('prev-week-btn').addEventListener('click', () => {
                currentWeekOffset--;
                renderWeek();
            });

            document.getElementById('next-week-btn').addEventListener('click', () => {
                currentWeekOffset++;
                renderWeek();
            });

            document.getElementById('current-week-btn').addEventListener('click', () => {
                currentWeekOffset = 0;
                renderWeek();
            });

            // Initial render
            renderWeek();
        }

        // Modal management functions
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalBackdrop = document.getElementById('unlock-modal-backdrop');
        const unlockModalPanel = document.getElementById('unlock-modal-panel');
        const unlockModalCancel = document.getElementById('unlock-modal-cancel');
        const unlockModalConfirm = document.getElementById('unlock-modal-confirm');
        let currentAssignmentId = null;

        function showUnlockModal(assignmentId) {
            currentAssignmentId = assignmentId;
            unlockModal.classList.remove('hidden');
            
            // Use requestAnimationFrame to ensure the browser paints the removal of 'hidden'
            // before applying the transition classes.
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // Backdrop enter
                    unlockModalBackdrop.classList.remove('opacity-0');
                    unlockModalBackdrop.classList.add('opacity-100');

                    // Panel enter
                    unlockModalPanel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    unlockModalPanel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                });
            });

            // Focus the confirm button for accessibility
            setTimeout(() => unlockModalConfirm.focus(), 100);
        }

        function hideUnlockModal() {
            // Backdrop leave
            unlockModalBackdrop.classList.remove('opacity-100');
            unlockModalBackdrop.classList.add('opacity-0');

            // Panel leave
            unlockModalPanel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            unlockModalPanel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            // Wait for transition to finish
            unlockModalPanel.addEventListener('transitionend', function() {
                unlockModal.classList.add('hidden');
            }, { once: true });
            
            currentAssignmentId = null;
        }

        function unlockAssignment() {
            if (currentAssignmentId) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/unlock';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'assignment_id';
                input.value = currentAssignmentId;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Unlock modal event listeners
        if (unlockModalCancel) {
            unlockModalCancel.addEventListener('click', hideUnlockModal);
        }
        if (unlockModalConfirm) {
            unlockModalConfirm.addEventListener('click', function () {
                unlockAssignment();
                hideUnlockModal();
            });
        }

        // Details Modal management
        const detailsModal = document.getElementById('details-modal');
        const detailsModalBackdrop = document.getElementById('details-modal-backdrop');
        const detailsModalPanel = document.getElementById('details-modal-panel');
        const detailsModalClose = document.getElementById('details-modal-close');
        const detailsModalContent = document.getElementById('details-modal-content');

        function showDetailsModal(assignmentId) {
            detailsModal.classList.remove('hidden');
            detailsModalContent.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
            
            // Use requestAnimationFrame for smooth transitions
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    detailsModalBackdrop.classList.remove('opacity-0');
                    detailsModalBackdrop.classList.add('opacity-100');
                    detailsModalPanel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    detailsModalPanel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                });
            });

            // Fetch assignment details via AJAX
            fetch(`/api/assignment-details?assignment_id=${assignmentId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch assignment details');
                    }
                    return response.json();
                })
                .then(data => {
                    // Build the details HTML using DOM manipulation to prevent XSS
                    const container = document.createElement('div');
                    container.className = 'space-y-3';

                    // Calculation date section
                    const dateSection = document.createElement('div');
                    dateSection.className = 'bg-gray-50 rounded-lg p-3';
                    
                    const dateLabel = document.createElement('p');
                    dateLabel.className = 'text-xs text-gray-500 uppercase tracking-wide font-semibold mb-2';
                    dateLabel.textContent = 'Calculation Date';
                    
                    const dateValue = document.createElement('p');
                    dateValue.className = 'text-sm font-medium text-gray-900';
                    dateValue.textContent = data.calculation_date;
                    
                    dateSection.appendChild(dateLabel);
                    dateSection.appendChild(dateValue);
                    container.appendChild(dateSection);

                    // Parents grid
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 gap-3';

                    // Parent A section
                    const parentASection = document.createElement('div');
                    parentASection.className = 'bg-blue-50 rounded-lg p-3';
                    
                    const parentAName = document.createElement('p');
                    parentAName.className = 'text-xs text-blue-700 uppercase tracking-wide font-semibold mb-2';
                    parentAName.textContent = data.parent_a_name;
                    
                    const parentAStats = document.createElement('div');
                    parentAStats.className = 'space-y-1';
                    
                    const parentATotal = document.createElement('p');
                    parentATotal.className = 'text-sm text-gray-700';
                    const parentATotalLabel = document.createElement('span');
                    parentATotalLabel.className = 'font-medium';
                    parentATotalLabel.textContent = 'Total:';
                    parentATotal.appendChild(parentATotalLabel);
                    parentATotal.appendChild(document.createTextNode(' ' + data.parent_a_total_count));
                    
                    const parentALast30 = document.createElement('p');
                    parentALast30.className = 'text-sm text-gray-700';
                    const parentALast30Label = document.createElement('span');
                    parentALast30Label.className = 'font-medium';
                    parentALast30Label.textContent = 'Last 30 days:';
                    parentALast30.appendChild(parentALast30Label);
                    parentALast30.appendChild(document.createTextNode(' ' + data.parent_a_last_30_days));
                    
                    parentAStats.appendChild(parentATotal);
                    parentAStats.appendChild(parentALast30);
                    parentASection.appendChild(parentAName);
                    parentASection.appendChild(parentAStats);
                    grid.appendChild(parentASection);

                    // Parent B section
                    const parentBSection = document.createElement('div');
                    parentBSection.className = 'bg-orange-50 rounded-lg p-3';
                    
                    const parentBName = document.createElement('p');
                    parentBName.className = 'text-xs text-orange-700 uppercase tracking-wide font-semibold mb-2';
                    parentBName.textContent = data.parent_b_name;
                    
                    const parentBStats = document.createElement('div');
                    parentBStats.className = 'space-y-1';
                    
                    const parentBTotal = document.createElement('p');
                    parentBTotal.className = 'text-sm text-gray-700';
                    const parentBTotalLabel = document.createElement('span');
                    parentBTotalLabel.className = 'font-medium';
                    parentBTotalLabel.textContent = 'Total:';
                    parentBTotal.appendChild(parentBTotalLabel);
                    parentBTotal.appendChild(document.createTextNode(' ' + data.parent_b_total_count));
                    
                    const parentBLast30 = document.createElement('p');
                    parentBLast30.className = 'text-sm text-gray-700';
                    const parentBLast30Label = document.createElement('span');
                    parentBLast30Label.className = 'font-medium';
                    parentBLast30Label.textContent = 'Last 30 days:';
                    parentBLast30.appendChild(parentBLast30Label);
                    parentBLast30.appendChild(document.createTextNode(' ' + data.parent_b_last_30_days));
                    
                    parentBStats.appendChild(parentBTotal);
                    parentBStats.appendChild(parentBLast30);
                    parentBSection.appendChild(parentBName);
                    parentBSection.appendChild(parentBStats);
                    grid.appendChild(parentBSection);

                    container.appendChild(grid);

                    // Decision Reason section
                    const reasonSection = document.createElement('div');
                    reasonSection.className = 'bg-purple-50 rounded-lg p-3';
                    
                    const reasonTitle = document.createElement('p');
                    reasonTitle.className = 'text-xs text-purple-700 uppercase tracking-wide font-semibold mb-2';
                    reasonTitle.textContent = 'Decision Reason';
                    
                    const reasonBadge = document.createElement('p');
                    reasonBadge.className = 'text-sm font-bold text-purple-900 mb-2';
                    reasonBadge.textContent = data.decision_reason;
                    
                    reasonSection.appendChild(reasonTitle);
                    reasonSection.appendChild(reasonBadge);

                    // Add explanation based on decision reason
                    const explanations = {
                        'Unavailability': 'One parent was unavailable on this day based on configured schedule constraints.',
                        'Total Count': 'This parent had fewer total assignments overall, helping maintain long-term balance.',
                        'Recent Count': 'This parent had fewer assignments in the last 30 days, ensuring fair recent distribution.',
                        'Consecutive Limit': 'Prevents one parent from having too many consecutive night assignments (limit: 2).',
                        'Alternating': 'Both parents had equal counts, so the algorithm maintained an alternating pattern.',
                        'Override': 'This assignment was manually changed in Google Calendar by a user.'
                    };
                    
                    const reasonExplanation = document.createElement('p');
                    reasonExplanation.className = 'text-xs text-gray-600 italic';
                    reasonExplanation.textContent = explanations[data.decision_reason] || 'Assignment made by the fairness algorithm.';
                    
                    reasonSection.appendChild(reasonExplanation);
                    container.appendChild(reasonSection);

                    // Explanation section
                    const explanationSection = document.createElement('div');
                    explanationSection.className = 'bg-indigo-50 rounded-lg p-3';
                    
                    const explanationTitle = document.createElement('p');
                    explanationTitle.className = 'text-xs text-indigo-700 uppercase tracking-wide font-semibold mb-1';
                    explanationTitle.textContent = 'How the algorithm works';
                    
                    const explanationText = document.createElement('p');
                    explanationText.className = 'text-sm text-gray-700';
                    explanationText.textContent = 'The fairness algorithm evaluates multiple criteria in priority order: (1) Parent availability, (2) Total assignment counts, (3) Recent counts (last 30 days), (4) Consecutive limit (max 2), (5) Alternating pattern.';
                    
                    explanationSection.appendChild(explanationTitle);
                    explanationSection.appendChild(explanationText);
                    container.appendChild(explanationSection);

                    // Replace modal content
                    detailsModalContent.replaceChildren(container);
                })
                .catch(error => {
                    console.error('Error fetching assignment details:', error);
                    const errorContainer = document.createElement('div');
                    errorContainer.className = 'bg-red-50 rounded-lg p-3';
                    const errorText = document.createElement('p');
                    errorText.className = 'text-sm text-red-700';
                    errorText.textContent = 'Failed to load assignment details. This assignment may not have detailed information available.';
                    errorContainer.appendChild(errorText);
                    detailsModalContent.replaceChildren(errorContainer);
                });

            setTimeout(() => detailsModalClose.focus(), 100);
        }

        function hideDetailsModal() {
            detailsModalBackdrop.classList.remove('opacity-100');
            detailsModalBackdrop.classList.add('opacity-0');
            detailsModalPanel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            detailsModalPanel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            detailsModalPanel.addEventListener('transitionend', function() {
                detailsModal.classList.add('hidden');
            }, { once: true });
        }

        // Details modal event listeners
        if (detailsModalClose) {
            detailsModalClose.addEventListener('click', hideDetailsModal);
        }

        // Close modals on backdrop click
        if (unlockModal) {
            unlockModal.addEventListener('click', function (e) {
                if (!unlockModalPanel.contains(e.target)) {
                    hideUnlockModal();
                }
            });
        }
        
        if (detailsModal) {
            detailsModal.addEventListener('click', function (e) {
                if (!detailsModalPanel.contains(e.target)) {
                    hideDetailsModal();
                }
            });
        }
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!unlockModal.classList.contains('hidden')) {
                    hideUnlockModal();
                }
                if (!detailsModal.classList.contains('hidden')) {
                    hideDetailsModal();
                }
                const syncModal = document.getElementById('sync-modal');
                if (syncModal && !syncModal.classList.contains('hidden')) {
                    // Only allow closing if not in loading state
                    const closeContainer = document.getElementById('sync-modal-close-container');
                    if (closeContainer && !closeContainer.classList.contains('hidden')) {
                        hideSyncModal();
                    }
                }
            }
        });

        // Sync Modal Management
        const syncBtn = document.getElementById('sync-btn');
        const syncModal = document.getElementById('sync-modal');
        const syncModalBackdrop = document.getElementById('sync-modal-backdrop');
        const syncModalPanel = document.getElementById('sync-modal-panel');
        const syncLoading = document.getElementById('sync-loading');
        const syncSuccess = document.getElementById('sync-success');
        const syncError = document.getElementById('sync-error');
        const syncModalCloseContainer = document.getElementById('sync-modal-close-container');
        const syncModalClose = document.getElementById('sync-modal-close');

        function showSyncModal() {
            // Reset to loading state
            syncLoading.classList.remove('hidden');
            syncSuccess.classList.add('hidden');
            syncError.classList.add('hidden');
            syncModalCloseContainer.classList.add('hidden');
            
            syncModal.classList.remove('hidden');
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    syncModalBackdrop.classList.remove('opacity-0');
                    syncModalBackdrop.classList.add('opacity-100');
                    syncModalPanel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    syncModalPanel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                });
            });
        }

        function showSyncSuccess(message) {
            syncLoading.classList.add('hidden');
            syncSuccess.classList.remove('hidden');
            syncError.classList.add('hidden');
            syncModalCloseContainer.classList.remove('hidden');
            if (message) {
                document.getElementById('sync-success-message').textContent = message;
            }
        }

        function showSyncError(message) {
            syncLoading.classList.add('hidden');
            syncSuccess.classList.add('hidden');
            syncError.classList.remove('hidden');
            syncModalCloseContainer.classList.remove('hidden');
            if (message) {
                document.getElementById('sync-error-message').textContent = message;
            }
        }

        function hideSyncModal() {
            syncModalBackdrop.classList.remove('opacity-100');
            syncModalBackdrop.classList.add('opacity-0');
            syncModalPanel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            syncModalPanel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            syncModalPanel.addEventListener('transitionend', function handler() {
                syncModal.classList.add('hidden');
                syncModalPanel.removeEventListener('transitionend', handler);
            });
        }

        async function performSync() {
            showSyncModal();
            
            // Get today's date in the user's local timezone (YYYY-MM-DD format)
            const startDate = getLocalDateString(new Date());
            
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ start_date: startDate }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSyncSuccess(data.message || 'Your schedule has been synced successfully.');
                    // Reload the page after a short delay to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showSyncError(data.error || 'An error occurred while syncing.');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showSyncError('Network error. Please check your connection and try again.');
            }
        }

        if (syncBtn) {
            syncBtn.addEventListener('click', performSync);
        }

        if (syncModalClose) {
            syncModalClose.addEventListener('click', hideSyncModal);
        }

        // Close sync modal on backdrop click (only if not loading)
        if (syncModal) {
            syncModal.addEventListener('click', function(e) {
                if (!syncModalPanel.contains(e.target)) {
                    // Only allow closing if not in loading state
                    if (!syncModalCloseContainer.classList.contains('hidden')) {
                        hideSyncModal();
                    }
                }
            });
        }
    });
</script>
{{end}}