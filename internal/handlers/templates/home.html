{{define "title"}}Night Routine - Home{{end}}

{{define "content"}}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Dashboard</h2>
    <p class="text-slate-600 text-lg">Manage your family's night routine schedule</p>
</div>

<!-- Alerts -->
{{if .ErrorMessage}}
<div class="bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚ö†Ô∏è</span>
    <div>
        <strong class="font-bold block mb-1">Error</strong>
        <span>{{.ErrorMessage}}</span>
    </div>
</div>
{{end}}

{{if .SuccessMessage}}
<div class="bg-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚úì</span>
    <div>
        <strong class="font-bold block mb-1">Success</strong>
        <span>{{.SuccessMessage}}</span>
    </div>
</div>
{{end}}

<!-- Connection Status Card -->
<div
    class="bg-white rounded-2xl shadow-xl p-8 mb-8 border {{if .IsAuthenticated}}border-emerald-200{{else}}border-rose-200{{end}}">
    {{if .IsAuthenticated}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-emerald-100 rounded-full p-3">
            <span class="text-3xl">‚úì</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Connected</h2>
            <p class="text-slate-600">Google Calendar is active</p>
        </div>
    </div>
    {{if .CalendarID}}
    <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <p class="text-sm text-slate-600 mb-1">Active Calendar</p>
        {{if .CalendarName}}
        <p class="text-slate-900 font-medium text-lg">{{.CalendarName}}</p>
        <p class="text-slate-500 text-sm break-all">{{.CalendarID}}</p>
        {{else}}
        <p class="text-slate-900 font-medium break-all">{{.CalendarID}}</p>
        {{end}}
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a href="/calendars"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üìÖ Change Calendar
        </a>
        <button type="button" id="sync-btn"
            class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üîÑ Sync Now
        </button>
    </div>
    {{else}}
    <p class="text-slate-700 mb-6">No calendar selected yet</p>
    <a href="/calendars"
        class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üìÖ Select Calendar
    </a>
    {{end}}
    {{else}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-rose-100 rounded-full p-3">
            <span class="text-3xl">‚úó</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Not Connected</h2>
            <p class="text-slate-600">Connect to get started</p>
        </div>
    </div>
    <p class="text-slate-700 mb-6">Link your Google Calendar to begin managing your night routine schedule</p>
    <a href="/auth"
        class="inline-block bg-linear-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üîó Connect Google Calendar
    </a>
    {{end}}
</div>

<!-- Calendar Section -->
{{if and .IsAuthenticated .CalendarWeeks}}
<!-- Desktop Calendar View (Full Month) - Hidden on mobile -->
<div class="hidden md:block bg-white rounded-2xl shadow-xl p-6 md:p-8">
    <div class="mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">üìÖ {{.CurrentMonth}}</h2>
        <p class="text-slate-600">Your night routine assignments</p>
    </div>
    <div class="overflow-x-auto -mx-6 md:-mx-8 px-6 md:px-8">
        <table class="w-full border-collapse min-w-full" id="assignment-calendar" role="table" aria-label="Monthly calendar of night routine assignments">
            <caption class="sr-only">{{.CurrentMonth}} night routine assignment calendar</caption>
            <thead>
                <tr>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tl-xl">
                        Mon</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Tue</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Wed</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Thu</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Fri</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Sat</th>
                    <th scope="col"
                        class="bg-linear-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tr-xl">
                        Sun</th>
                </tr>
            </thead>
            <tbody>
                {{range .CalendarWeeks}}
                <tr>
                    {{range .}}
                    <td class="border border-slate-200 p-3 text-center align-top h-24 md:h-28 relative cursor-pointer transition-all duration-200
                            {{if not .IsCurrentMonth}}bg-slate-50 text-slate-400{{else}}bg-white hover:shadow-lg{{end}}
                            {{if .Assignment}}
                                {{if eq .Assignment.ParentType.String "ParentA"}}bg-linear-to-br from-blue-50 to-indigo-100 text-indigo-900 border-indigo-200 hover:from-blue-100 hover:to-indigo-200{{end}}
                                {{if eq .Assignment.ParentType.String "ParentB"}}bg-linear-to-br from-amber-50 to-orange-100 text-orange-900 border-orange-200 hover:from-amber-100 hover:to-orange-200{{end}}
                                {{if eq .Assignment.DecisionReason "Override"}}overridden{{end}}
                            {{end}}" 
                        data-date="{{.Date.Format "2006-01-02"}}" 
                        {{if .Assignment}}data-assignment-id="{{.Assignment.ID}}"{{end}}
                        aria-label="{{.Date.Format "January 2, 2006"}}{{if .Assignment}} - {{.Assignment.Parent}} assigned{{if eq .Assignment.DecisionReason "Override"}} - Locked (manually overridden){{end}}{{end}}">
                        <span class="block text-lg md:text-xl font-bold mb-1">{{.DayOfMonth}}</span>
                        {{if .Assignment}}
                        <span class="block text-xs md:text-sm font-semibold">{{.Assignment.Parent}}</span>
                        {{if .Assignment.DecisionReason}}
                        <span class="block text-xs text-slate-500 mt-1">{{.Assignment.DecisionReason}}</span>
                        {{end}}
                        {{end}}
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<!-- Mobile Calendar View (Weekly) - Visible only on mobile -->
<div class="block md:hidden bg-white rounded-2xl shadow-xl p-4">
    <div class="mb-4">
        <h2 class="text-xl font-bold text-slate-900 mb-2">üìÖ <span id="mobile-week-label">{{.CurrentMonth}}</span></h2>
        <p class="text-slate-600 text-sm">Your night routine assignments</p>
    </div>
    
    <!-- Week Navigation -->
    <div class="flex items-center justify-between mb-4 gap-2">
        <button id="prev-week-btn" 
            aria-label="Go to previous week"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span aria-hidden="true">‚Üê</span>
            <span>Previous</span>
        </button>
        <button id="current-week-btn"
            aria-label="Go to current week"
            class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg transition-all duration-200 hover:shadow-lg text-sm">
            Today
        </button>
        <button id="next-week-btn"
            aria-label="Go to next week"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span>Next</span>
            <span aria-hidden="true">‚Üí</span>
        </button>
    </div>

    <!-- Weekly Calendar Tables (split into 2 rows for mobile) -->
    <div role="region" aria-label="Weekly calendar view">
        <!-- First row: Mon-Thu -->
        <table class="w-full border-collapse mb-2" id="mobile-assignment-calendar-row1" role="table" aria-label="Monday through Thursday assignments">
            <caption class="sr-only">Monday through Thursday night routine assignments</caption>
            <thead>
                <tr>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Mon</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Tue</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Wed</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Thu</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row1">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
        
        <!-- Second row: Fri-Sun -->
        <table class="w-full border-collapse" id="mobile-assignment-calendar-row2" role="table" aria-label="Friday through Sunday assignments">
            <caption class="sr-only">Friday through Sunday night routine assignments</caption>
            <thead>
                <tr>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Fri</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Sat</th>
                    <th scope="col" class="bg-linear-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Sun</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row2">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>
{{end}}
<!-- End Calendar Section -->

<!-- Unlock Modal -->
<div id="unlock-modal" class="relative z-10 hidden" aria-labelledby="unlock-modal-title" role="dialog" aria-modal="true">
    <div id="unlock-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="unlock-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-lg">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="unlock-modal-title">Unlock Event</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">
                            This event will be re-evaluated by the scheduler. Are you sure you want to unlock this assignment?
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="unlock-modal-confirm"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:ml-3 sm:w-auto">
                    Unlock Event
                </button>
                <button type="button" id="unlock-modal-cancel"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 sm:mt-0 sm:w-auto">
                    Cancel
                </button>
            </div>
        </div>
      </div>
    </div>
</div>

<!-- Assignment Details Modal -->
<div id="details-modal" class="relative z-10 hidden" aria-labelledby="details-modal-title" role="dialog" aria-modal="true">
    <div id="details-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="details-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-lg">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="details-modal-title">Assignment Details</h3>
                    <div class="mt-4" id="details-modal-content">
                        <p class="text-sm text-gray-500">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="details-modal-close"
                    class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-indigo-600 sm:w-auto">
                    Close
                </button>
            </div>
        </div>
      </div>
    </div>
</div>

<!-- Sync Loading Modal -->
<div id="sync-modal" class="relative z-10 hidden" aria-label="Sync Calendar" role="dialog" aria-modal="true">
    <div id="sync-modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div id="sync-modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-sm">
            <div class="text-center">
                <!-- Loading State -->
                <div id="sync-loading" class="block">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 mb-4">
                        <svg class="h-6 w-6 text-emerald-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Syncing Calendar</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">Please wait while we sync your schedule with Google Calendar...</p>
                    </div>
                </div>
                <!-- Success State -->
                <div id="sync-success" class="hidden">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 mb-4">
                        <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Sync Complete!</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="sync-success-message">Your schedule has been synced successfully.</p>
                    </div>
                </div>
                <!-- Error State -->
                <div id="sync-error" class="hidden">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Sync Failed</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="sync-error-message">An error occurred while syncing.</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 hidden" id="sync-modal-close-container">
                <button type="button" id="sync-modal-close"
                    class="inline-flex w-full justify-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-emerald-600">
                    Close
                </button>
            </div>
        </div>
      </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<!-- Inject calendar data for JavaScript -->
<script>
    window.CALENDAR_DATA = {{.CalendarData | js}};
</script>
<!-- Load bundled JavaScript -->
<script type="module" src="/static/js/home.js?v={{.JSETags.home}}"></script>
{{end}}
