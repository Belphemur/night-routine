<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night Routine - Home</title>
    <link href="/static/css/tailwind.css" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg border-b border-slate-200">
        <div class="container mx-auto px-4 py-4 max-w-7xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üåô</span>
                    <h1 class="text-2xl font-bold text-slate-900">Night Routine</h1>
                </div>
                {{if .IsAuthenticated}}
                <div class="flex items-center gap-2">
                    <a href="/" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-colors duration-200">
                        üè† Home
                    </a>
                    <a href="/calendars" class="text-slate-700 hover:bg-slate-100 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        üìÖ Calendars
                    </a>
                    <a href="/statistics" class="text-slate-700 hover:bg-slate-100 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        üìä Stats
                    </a>
                    <a href="/settings" class="text-slate-700 hover:bg-slate-100 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        ‚öôÔ∏è Settings
                    </a>
                </div>
                {{end}}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-8 max-w-7xl">
        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Dashboard</h2>
            <p class="text-slate-600 text-lg">Manage your family's night routine schedule</p>
        </div>

        <!-- Alerts -->
        {{if .ErrorMessage}}
        <div class="bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <div>
                <strong class="font-bold block mb-1">Error</strong>
                <span>{{.ErrorMessage}}</span>
            </div>
        </div>
        {{end}}

        {{if .SuccessMessage}}
        <div class="bg-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
            <span class="text-2xl">‚úì</span>
            <div>
                <strong class="font-bold block mb-1">Success</strong>
                <span>{{.SuccessMessage}}</span>
            </div>
        </div>
        {{end}}

        <!-- Connection Status Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border {{if .IsAuthenticated}}border-emerald-200{{else}}border-rose-200{{end}}">
            {{if .IsAuthenticated}}
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-emerald-100 rounded-full p-3">
                    <span class="text-3xl">‚úì</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Connected</h2>
                    <p class="text-slate-600">Google Calendar is active</p>
                </div>
            </div>
            {{if .CalendarID}}
            <div class="bg-slate-50 rounded-xl p-4 mb-6">
                <p class="text-sm text-slate-600 mb-1">Active Calendar</p>
                <p class="text-slate-900 font-medium">{{.CalendarID}}</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <a href="/calendars" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
                    üìÖ Change Calendar
                </a>
                <a href="/sync" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
                    üîÑ Sync Now
                </a>
                <a href="/statistics" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
                    üìä Statistics
                </a>
                <a href="/settings" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
                    ‚öôÔ∏è Settings
                </a>
            </div>
            {{else}}
            <p class="text-slate-700 mb-6">No calendar selected yet</p>
            <a href="/calendars" class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
                üìÖ Select Calendar
            </a>
            {{end}}
            {{else}}
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-rose-100 rounded-full p-3">
                    <span class="text-3xl">‚úó</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Not Connected</h2>
                    <p class="text-slate-600">Connect to get started</p>
                </div>
            </div>
            <p class="text-slate-700 mb-6">Link your Google Calendar to begin managing your night routine schedule</p>
            <a href="/auth" class="inline-block bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
                üîó Connect Google Calendar
            </a>
            {{end}}
        </div>

        <!-- Calendar Section -->
        {{if and .IsAuthenticated .CalendarWeeks}}
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <div class="mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">üìÖ {{.CurrentMonth}}</h2>
                <p class="text-slate-600">Your night routine assignments</p>
            </div>
            <div class="overflow-x-auto -mx-6 md:-mx-8 px-6 md:px-8">
                <table class="w-full border-collapse min-w-full" id="assignment-calendar">
                    <thead>
                        <tr>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tl-xl">Mon</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">Tue</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">Wed</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">Thu</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">Fri</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">Sat</th>
                            <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tr-xl">Sun</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .CalendarWeeks}}
                        <tr>
                            {{range .}}
                            <td class="border border-slate-200 p-3 text-center align-top h-24 md:h-28 relative cursor-pointer transition-all duration-200
                                {{if not .IsCurrentMonth}}bg-slate-50 text-slate-400{{else}}bg-white hover:shadow-lg{{end}}
                                {{if .Assignment}}
                                    {{if eq .Assignment.ParentType.String "ParentA"}}bg-gradient-to-br from-blue-50 to-indigo-100 text-indigo-900 border-indigo-200 hover:from-blue-100 hover:to-indigo-200{{end}}
                                    {{if eq .Assignment.ParentType.String "ParentB"}}bg-gradient-to-br from-amber-50 to-orange-100 text-orange-900 border-orange-200 hover:from-amber-100 hover:to-orange-200{{end}}
                                    {{if eq .Assignment.DecisionReason "Override"}}overridden{{end}}
                                {{end}}"
                                data-date="{{.Date.Format "2006-01-02"}}"
                                {{if .Assignment}}data-assignment-id="{{.Assignment.ID}}"{{end}}
                                aria-label="{{.Date.Format "January 2, 2006"}}{{if .Assignment}} - {{.Assignment.Parent}} assigned{{if eq .Assignment.DecisionReason "Override"}} - Locked (manually overridden){{end}}{{end}}">
                                <span class="block text-lg md:text-xl font-bold mb-1">{{.DayOfMonth}}</span>
                                {{if .Assignment}}
                                <span class="block text-xs md:text-sm font-semibold">{{.Assignment.Parent}}</span>
                                {{if .Assignment.DecisionReason}}
                                <span class="hidden md:block absolute bottom-full left-1/2 transform -translate-x-1/2 bg-slate-900 text-white text-xs rounded-lg py-2 px-3 opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap mb-2 shadow-xl">{{.Assignment.DecisionReason}}</span>
                                <span class="block md:hidden text-xs italic text-slate-600 mt-1">{{.Assignment.DecisionReason}}</span>
                                {{end}}
                                {{end}}
                            </td>
                            {{end}}
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}
        <!-- End Calendar Section -->

        <!-- Confirmation Modal -->
        <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center backdrop-blur-sm" id="unlock-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-description">
            <div class="bg-white rounded-2xl p-8 max-w-md w-11/12 shadow-2xl">
                <div class="mb-6 flex items-start gap-4">
                    <div class="bg-blue-100 rounded-full p-3 flex-shrink-0">
                        <span class="text-3xl">üîì</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2" id="modal-title">Unlock Event</h2>
                        <p id="modal-description" class="text-slate-700">
                            This event will be re-evaluated by the scheduler. Are you sure?
                        </p>
                    </div>
                </div>
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-3">
                    <button type="button" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-xl transition-all duration-200" id="modal-cancel">
                        Cancel
                    </button>
                    <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg" id="modal-confirm">
                        Unlock Event
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-6 mt-auto">
        <div class="container mx-auto px-4 max-w-7xl">
            <p class="text-center text-slate-600 text-sm">¬© 2025 Night Routine - Keeping families organized</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Function to format date as YYYY-MM-DD (local timezone)
            function getLocalDateString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            const today = new Date();
            const todayString = getLocalDateString(today);
            const todayCell = document.querySelector(`.calendar td[data-date="${todayString}"]`);

            if (todayCell) {
                todayCell.classList.add('bg-yellow-100', 'font-bold');
            }

            // Calendar interaction management
            const calendar = document.getElementById('assignment-calendar');
            if (calendar) {
                // Handle clicks on calendar
                calendar.addEventListener('click', function (e) {
                    const cell = e.target.closest('td.overridden');
                    
                    // If clicked on an overridden cell, show unlock modal
                    if (cell) {
                        e.stopPropagation();
                        const assignmentId = cell.dataset.assignmentId;
                        if (assignmentId) {
                            showUnlockModal(assignmentId);
                        }
                    }
                });
            }

            // Modal management functions
            const modal = document.getElementById('unlock-modal');
            const modalCancel = document.getElementById('modal-cancel');
            const modalConfirm = document.getElementById('modal-confirm');
            let currentAssignmentId = null;
            let previousActiveElement = null;

            function showUnlockModal(assignmentId) {
                currentAssignmentId = assignmentId;
                previousActiveElement = document.activeElement;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                modalConfirm.focus();
            }

            function hideUnlockModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                currentAssignmentId = null;
                if (previousActiveElement) {
                    previousActiveElement.focus();
                }
            }

            function unlockAssignment() {
                if (currentAssignmentId) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/unlock';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'assignment_id';
                    input.value = currentAssignmentId;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            }

            // Modal event listeners
            if (modalCancel) {
                modalCancel.addEventListener('click', hideUnlockModal);
            }
            if (modalConfirm) {
                modalConfirm.addEventListener('click', function() {
                    unlockAssignment();
                    hideUnlockModal();
                });
            }

            // Close modal on overlay click
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideUnlockModal();
                    }
                });

                // Keyboard accessibility
                modal.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        hideUnlockModal();
                    }
                });
            }
        });
    </script>

</body>

</html>
