{{define "title"}}Night Routine - Home{{end}}

{{define "content"}}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Dashboard</h2>
    <p class="text-slate-600 text-lg">Manage your family's night routine schedule</p>
</div>

<!-- Alerts -->
{{if .ErrorMessage}}
<div class="bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚ö†Ô∏è</span>
    <div>
        <strong class="font-bold block mb-1">Error</strong>
        <span>{{.ErrorMessage}}</span>
    </div>
</div>
{{end}}

{{if .SuccessMessage}}
<div class="bg-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚úì</span>
    <div>
        <strong class="font-bold block mb-1">Success</strong>
        <span>{{.SuccessMessage}}</span>
    </div>
</div>
{{end}}

<!-- Connection Status Card -->
<div
    class="bg-white rounded-2xl shadow-xl p-8 mb-8 border {{if .IsAuthenticated}}border-emerald-200{{else}}border-rose-200{{end}}">
    {{if .IsAuthenticated}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-emerald-100 rounded-full p-3">
            <span class="text-3xl">‚úì</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Connected</h2>
            <p class="text-slate-600">Google Calendar is active</p>
        </div>
    </div>
    {{if .CalendarID}}
    <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <p class="text-sm text-slate-600 mb-1">Active Calendar</p>
        {{if .CalendarName}}
        <p class="text-slate-900 font-medium text-lg">{{.CalendarName}}</p>
        <p class="text-slate-500 text-sm break-all">{{.CalendarID}}</p>
        {{else}}
        <p class="text-slate-900 font-medium break-all">{{.CalendarID}}</p>
        {{end}}
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a href="/calendars"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üìÖ Change Calendar
        </a>
        <a href="/sync"
            class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üîÑ Sync Now
        </a>
    </div>
    {{else}}
    <p class="text-slate-700 mb-6">No calendar selected yet</p>
    <a href="/calendars"
        class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üìÖ Select Calendar
    </a>
    {{end}}
    {{else}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-rose-100 rounded-full p-3">
            <span class="text-3xl">‚úó</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Not Connected</h2>
            <p class="text-slate-600">Connect to get started</p>
        </div>
    </div>
    <p class="text-slate-700 mb-6">Link your Google Calendar to begin managing your night routine schedule</p>
    <a href="/auth"
        class="inline-block bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üîó Connect Google Calendar
    </a>
    {{end}}
</div>

<!-- Calendar Section -->
{{if and .IsAuthenticated .CalendarWeeks}}
<!-- Desktop Calendar View (Full Month) - Hidden on mobile -->
<div class="hidden md:block bg-white rounded-2xl shadow-xl p-6 md:p-8">
    <div class="mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">üìÖ {{.CurrentMonth}}</h2>
        <p class="text-slate-600">Your night routine assignments</p>
    </div>
    <div class="overflow-x-auto -mx-6 md:-mx-8 px-6 md:px-8">
        <table class="w-full border-collapse min-w-full" id="assignment-calendar">
            <thead>
                <tr>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tl-xl">
                        Mon</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Tue</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Wed</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Thu</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Fri</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Sat</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tr-xl">
                        Sun</th>
                </tr>
            </thead>
            <tbody>
                {{range .CalendarWeeks}}
                <tr>
                    {{range .}}
                    <td class="border border-slate-200 p-3 text-center align-top h-24 md:h-28 relative cursor-pointer transition-all duration-200
                            {{if not .IsCurrentMonth}}bg-slate-50 text-slate-400{{else}}bg-white hover:shadow-lg{{end}}
                            {{if .Assignment}}
                                {{if eq .Assignment.ParentType.String "ParentA"}}bg-gradient-to-br from-blue-50 to-indigo-100 text-indigo-900 border-indigo-200 hover:from-blue-100 hover:to-indigo-200{{end}}
                                {{if eq .Assignment.ParentType.String "ParentB"}}bg-gradient-to-br from-amber-50 to-orange-100 text-orange-900 border-orange-200 hover:from-amber-100 hover:to-orange-200{{end}}
                                {{if eq .Assignment.DecisionReason "Override"}}overridden{{end}}
                            {{end}}" 
                        data-date="{{.Date.Format "2006-01-02"}}" 
                        {{if .Assignment}}data-assignment-id="{{.Assignment.ID}}"{{end}}
                        aria-label="{{.Date.Format "January 2, 2006"}}{{if .Assignment}} - {{.Assignment.Parent}} assigned{{if eq .Assignment.DecisionReason "Override"}} - Locked (manually overridden){{end}}{{end}}">
                        <span class="block text-lg md:text-xl font-bold mb-1">{{.DayOfMonth}}</span>
                        {{if .Assignment}}
                        <span class="block text-xs md:text-sm font-semibold">{{.Assignment.Parent}}</span>
                        {{if .Assignment.DecisionReason}}
                        <span class="block text-xs text-slate-500 mt-1">{{.Assignment.DecisionReason}}</span>
                        {{end}}
                        {{end}}
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<!-- Mobile Calendar View (Weekly) - Visible only on mobile -->
<div class="block md:hidden bg-white rounded-2xl shadow-xl p-4">
    <div class="mb-4">
        <h2 class="text-xl font-bold text-slate-900 mb-2">üìÖ <span id="mobile-week-label">{{.CurrentMonth}}</span></h2>
        <p class="text-slate-600 text-sm">Your night routine assignments</p>
    </div>
    
    <!-- Week Navigation -->
    <div class="flex items-center justify-between mb-4 gap-2">
        <button id="prev-week-btn" 
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span>‚Üê</span>
            <span>Previous</span>
        </button>
        <button id="current-week-btn"
            class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg transition-all duration-200 hover:shadow-lg text-sm">
            Today
        </button>
        <button id="next-week-btn"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 hover:shadow-lg flex items-center gap-1">
            <span>Next</span>
            <span>‚Üí</span>
        </button>
    </div>

    <!-- Weekly Calendar Tables (split into 2 rows for mobile) -->
    <div>
        <!-- First row: Mon-Thu -->
        <table class="w-full border-collapse mb-2" id="mobile-assignment-calendar-row1">
            <thead>
                <tr>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Mon</th>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Tue</th>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Wed</th>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Thu</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row1">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
        
        <!-- Second row: Fri-Sun -->
        <table class="w-full border-collapse" id="mobile-assignment-calendar-row2">
            <thead>
                <tr>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tl-xl">Fri</th>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs">Sat</th>
                    <th class="bg-gradient-to-br from-slate-100 to-slate-200 p-2 text-center font-bold text-slate-700 text-xs rounded-tr-xl">Sun</th>
                </tr>
            </thead>
            <tbody id="mobile-calendar-body-row2">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>
{{end}}
<!-- End Calendar Section -->

<!-- Confirmation Modal -->
<div id="unlock-modal" class="relative z-10 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!--
      Background backdrop, show/hide based on modal state.
  
      Entering: "ease-out duration-300"
        From: "opacity-0"
        To: "opacity-100"
      Leaving: "ease-in duration-200"
        From: "opacity-100"
        To: "opacity-0"
    -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-out opacity-0"></div>
  
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <!--
          Modal panel, show/hide based on modal state.
  
          Entering: "ease-out duration-300"
            From: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            To: "opacity-100 translate-y-0 sm:scale-100"
          Leaving: "ease-in duration-200"
            From: "opacity-100 translate-y-0 sm:scale-100"
            To: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        -->
        <div id="modal-panel" class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all duration-300 ease-out opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95 sm:p-6 sm:my-8 sm:w-full sm:max-w-lg">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Unlock Event</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="modal-description">
                            This event will be re-evaluated by the scheduler. Are you sure you want to unlock this assignment?
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" id="modal-confirm"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:ml-3 sm:w-auto">
                    Unlock Event
                </button>
                <button type="button" id="modal-cancel"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 sm:mt-0 sm:w-auto">
                    Cancel
                </button>
            </div>
        </div>
      </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to format date as YYYY-MM-DD (local timezone)
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const todayString = getLocalDateString(today);
        const todayCell = document.querySelector(`#assignment-calendar td[data-date="${todayString}"]`);

        if (todayCell) {
            // Add custom today-cell class for styling
            todayCell.classList.add('today-cell');
        }

        // Calendar interaction management
        const calendar = document.getElementById('assignment-calendar');
        if (calendar) {
            // Handle clicks on calendar
            calendar.addEventListener('click', function (e) {
                const cell = e.target.closest('td.overridden');

                // If clicked on an overridden cell, show unlock modal
                if (cell) {
                    e.stopPropagation();
                    const assignmentId = cell.dataset.assignmentId;
                    if (assignmentId) {
                        showUnlockModal(assignmentId);
                    }
                }
            });
        }

        // Mobile Weekly Calendar Logic
        // Tailwind CSS classes used dynamically in JavaScript - DO NOT REMOVE
        // Classes: h-24 p-2 text-xs text-lg block font-bold mb-1 font-semibold text-slate-500 mt-1
        const mobileCalendarRow1 = document.getElementById('mobile-assignment-calendar-row1');
        const mobileCalendarRow2 = document.getElementById('mobile-assignment-calendar-row2');
        if (mobileCalendarRow1 && mobileCalendarRow2) {
            let currentWeekOffset = 0;
            
            // Use calendar data provided by the server as JSON
            const calendarData = {{.CalendarData | js}};
            const allDays = calendarData.map(day => ({
                date: new Date(day.dateStr + 'T00:00:00'),
                dateStr: day.dateStr,
                dayOfMonth: day.dayOfMonth,
                assignmentId: day.assignmentId || null,
                assignmentParent: day.assignmentParent || '',
                assignmentReason: day.assignmentReason || '',
                isOverridden: day.isOverridden || false,
                classes: day.cssClasses || ''
            }));

            function getMondayOfWeek(date) {
                // Create a completely independent copy using timestamp
                const d = new Date(date.getTime());
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                d.setDate(diff);
                return d;
            }

            function formatWeekLabel(mondayDate) {
                const sunday = new Date(mondayDate);
                sunday.setDate(sunday.getDate() + 6);
                
                const options = { month: 'long', day: 'numeric' };
                const mondayStr = mondayDate.toLocaleDateString('en-US', options);
                const sundayStr = sunday.toLocaleDateString('en-US', { ...options, year: 'numeric' });
                
                if (mondayDate.getMonth() === sunday.getMonth()) {
                    return `Week of ${mondayStr} - ${sunday.getDate()}, ${sunday.getFullYear()}`;
                }
                return `Week of ${mondayStr} - ${sundayStr}`;
            }

            function renderWeek() {
                const mondayOfTargetWeek = getMondayOfWeek(today);
                mondayOfTargetWeek.setDate(mondayOfTargetWeek.getDate() + (currentWeekOffset * 7));
                
                // Update week label
                const weekLabel = formatWeekLabel(mondayOfTargetWeek);
                document.getElementById('mobile-week-label').textContent = weekLabel;

                // Get the 7 days for this week
                const weekDays = [];
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(mondayOfTargetWeek);
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateStr = getLocalDateString(currentDate);
                    
                    // Find matching day in allDays
                    const dayData = allDays.find(d => d.dateStr === dateStr);
                    
                    // Default classes for days without data
                    const defaultClasses = 'border border-slate-200 p-2 text-center align-top h-20 relative bg-white';
                    
                    weekDays.push(dayData || {
                        date: currentDate,
                        dateStr: dateStr,
                        dayOfMonth: currentDate.getDate(),
                        assignmentId: null,
                        assignmentParent: '',
                        assignmentReason: '',
                        isOverridden: false,
                        classes: defaultClasses
                    });
                }

                // Render the week - split into two rows
                const tbody1 = document.getElementById('mobile-calendar-body-row1');
                const tbody2 = document.getElementById('mobile-calendar-body-row2');
                tbody1.replaceChildren();
                tbody2.replaceChildren();
                
                // Helper function to create a day cell
                function createDayCell(day) {
                    const td = document.createElement('td');
                    // Combine classes reliably with array filtering
                    td.className = [day.classes, 'h-24', 'p-2', 'text-xs'].filter(Boolean).join(' ');
                    td.setAttribute('data-date', day.dateStr);
                    if (day.assignmentId) {
                        td.setAttribute('data-assignment-id', day.assignmentId);
                    }
                    
                    // Check if this is today
                    if (day.dateStr === todayString) {
                        td.classList.add('today-cell');
                    }
                    
                    // Create elements safely without innerHTML to avoid XSS
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'block text-lg font-bold mb-1';
                    dayNumber.textContent = day.dayOfMonth;
                    td.appendChild(dayNumber);
                    
                    if (day.assignmentParent) {
                        const parentSpan = document.createElement('span');
                        parentSpan.className = 'block text-xs font-semibold';
                        parentSpan.textContent = day.assignmentParent;
                        td.appendChild(parentSpan);
                    }
                    
                    if (day.assignmentReason) {
                        const reasonSpan = document.createElement('span');
                        reasonSpan.className = 'block text-xs text-slate-500 mt-1';
                        reasonSpan.textContent = day.assignmentReason;
                        td.appendChild(reasonSpan);
                    }
                    
                    return td;
                }
                
                // First row: Mon-Thu (days 0-3)
                const row1 = document.createElement('tr');
                for (let i = 0; i < 4; i++) {
                    row1.appendChild(createDayCell(weekDays[i]));
                }
                tbody1.appendChild(row1);
                
                // Second row: Fri-Sun (days 4-6)
                const row2 = document.createElement('tr');
                for (let i = 4; i < 7; i++) {
                    row2.appendChild(createDayCell(weekDays[i]));
                }
                tbody2.appendChild(row2);

                // Add click handlers for overridden cells in both tables
                [tbody1, tbody2].forEach(tbody => {
                    tbody.querySelectorAll('td.overridden').forEach(cell => {
                        cell.style.cursor = 'pointer';
                        cell.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const assignmentId = this.getAttribute('data-assignment-id');
                            if (assignmentId) {
                                showUnlockModal(assignmentId);
                            }
                        });
                    });
                });
            }

            // Navigation button handlers
            document.getElementById('prev-week-btn').addEventListener('click', () => {
                currentWeekOffset--;
                renderWeek();
            });

            document.getElementById('next-week-btn').addEventListener('click', () => {
                currentWeekOffset++;
                renderWeek();
            });

            document.getElementById('current-week-btn').addEventListener('click', () => {
                currentWeekOffset = 0;
                renderWeek();
            });

            // Initial render
            renderWeek();
        }

        // Modal management functions
        const modal = document.getElementById('unlock-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalPanel = document.getElementById('modal-panel');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        let currentAssignmentId = null;

        function showUnlockModal(assignmentId) {
            currentAssignmentId = assignmentId;
            modal.classList.remove('hidden');
            
            // Use requestAnimationFrame to ensure the browser paints the removal of 'hidden'
            // before applying the transition classes.
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // Backdrop enter
                    modalBackdrop.classList.remove('opacity-0');
                    modalBackdrop.classList.add('opacity-100');

                    // Panel enter
                    modalPanel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    modalPanel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                });
            });

            // Focus the confirm button for accessibility
            setTimeout(() => modalConfirm.focus(), 100);
        }

        function hideUnlockModal() {
            // Backdrop leave
            modalBackdrop.classList.remove('opacity-100');
            modalBackdrop.classList.add('opacity-0');

            // Panel leave
            modalPanel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            modalPanel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            // Wait for transition to finish
            modalPanel.addEventListener('transitionend', function() {
                modal.classList.add('hidden');
            }, { once: true });
            
            currentAssignmentId = null;
        }

        function unlockAssignment() {
            if (currentAssignmentId) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/unlock';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'assignment_id';
                input.value = currentAssignmentId;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Modal event listeners
        if (modalCancel) {
            modalCancel.addEventListener('click', hideUnlockModal);
        }
        if (modalConfirm) {
            modalConfirm.addEventListener('click', function () {
                unlockAssignment();
                hideUnlockModal();
            });
        }

        // Close modal on backdrop click (clicking outside the panel)
        // Since we have a dedicated backdrop element now, we can just listen on that or the container
        // The container covers the whole screen, but the panel is inside it.
        // We can listen on the container, but check if the click target is the container or the backdrop.
        // Actually, the structure is: Container -> [Backdrop, ScrollContainer -> [CenteringDiv -> Panel]]
        // Clicking on ScrollContainer or CenteringDiv should close it.
        
        // Let's listen on the backdrop specifically if it's clickable, or the wrapper.
        // In the current structure, the backdrop is a sibling of the scroll container.
        // But the scroll container covers the backdrop.
        // So we should listen on the scroll container (the parent of the panel wrapper).
        
        // Let's just listen on the main modal container and check if the click is outside the panel.
        if (modal) {
            modal.addEventListener('click', function (e) {
                // If the click is on the backdrop or the wrapper (not inside the panel)
                if (!modalPanel.contains(e.target)) {
                    hideUnlockModal();
                }
            });
        }
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                hideUnlockModal();
            }
        });
    });
</script>
{{end}}