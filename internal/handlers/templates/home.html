{{define "title"}}Night Routine - Home{{end}}

{{define "content"}}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Dashboard</h2>
    <p class="text-slate-600 text-lg">Manage your family's night routine schedule</p>
</div>

<!-- Alerts -->
{{if .ErrorMessage}}
<div class="bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚ö†Ô∏è</span>
    <div>
        <strong class="font-bold block mb-1">Error</strong>
        <span>{{.ErrorMessage}}</span>
    </div>
</div>
{{end}}

{{if .SuccessMessage}}
<div class="bg-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg mb-6 flex items-start gap-3">
    <span class="text-2xl">‚úì</span>
    <div>
        <strong class="font-bold block mb-1">Success</strong>
        <span>{{.SuccessMessage}}</span>
    </div>
</div>
{{end}}

<!-- Connection Status Card -->
<div
    class="bg-white rounded-2xl shadow-xl p-8 mb-8 border {{if .IsAuthenticated}}border-emerald-200{{else}}border-rose-200{{end}}">
    {{if .IsAuthenticated}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-emerald-100 rounded-full p-3">
            <span class="text-3xl">‚úì</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Connected</h2>
            <p class="text-slate-600">Google Calendar is active</p>
        </div>
    </div>
    {{if .CalendarID}}
    <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <p class="text-sm text-slate-600 mb-1">Active Calendar</p>
        <p class="text-slate-900 font-medium">{{.CalendarID}}</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a href="/calendars"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üìÖ Change Calendar
        </a>
        <a href="/sync"
            class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-center transition-all duration-200 hover:shadow-lg hover:scale-105">
            üîÑ Sync Now
        </a>
    </div>
    {{else}}
    <p class="text-slate-700 mb-6">No calendar selected yet</p>
    <a href="/calendars"
        class="inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üìÖ Select Calendar
    </a>
    {{end}}
    {{else}}
    <div class="flex items-center gap-3 mb-6">
        <div class="bg-rose-100 rounded-full p-3">
            <span class="text-3xl">‚úó</span>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Not Connected</h2>
            <p class="text-slate-600">Connect to get started</p>
        </div>
    </div>
    <p class="text-slate-700 mb-6">Link your Google Calendar to begin managing your night routine schedule</p>
    <a href="/auth"
        class="inline-block bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 hover:shadow-lg hover:scale-105">
        üîó Connect Google Calendar
    </a>
    {{end}}
</div>

<!-- Calendar Section -->
{{if and .IsAuthenticated .CalendarWeeks}}
<div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
    <div class="mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">üìÖ {{.CurrentMonth}}</h2>
        <p class="text-slate-600">Your night routine assignments</p>
    </div>
    <div class="overflow-x-auto -mx-6 md:-mx-8 px-6 md:px-8">
        <table class="w-full border-collapse min-w-full" id="assignment-calendar">
            <thead>
                <tr>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tl-xl">
                        Mon</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Tue</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Wed</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Thu</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Fri</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base">
                        Sat</th>
                    <th
                        class="bg-gradient-to-br from-slate-100 to-slate-200 p-3 text-center font-bold text-slate-700 text-sm md:text-base rounded-tr-xl">
                        Sun</th>
                </tr>
            </thead>
            <tbody>
                {{range .CalendarWeeks}}
                <tr>
                    {{range .}}
                    <td class="border border-slate-200 p-3 text-center align-top h-24 md:h-28 relative cursor-pointer transition-all duration-200
                            {{if not .IsCurrentMonth}}bg-slate-50 text-slate-400{{else}}bg-white hover:shadow-lg{{end}}
                            {{if .Assignment}}
                                {{if eq .Assignment.ParentType.String "ParentA"}}bg-gradient-to-br from-blue-50 to-indigo-100 text-indigo-900 border-indigo-200 hover:from-blue-100 hover:to-indigo-200{{end}}
                                {{if eq .Assignment.ParentType.String "ParentB"}}bg-gradient-to-br from-amber-50 to-orange-100 text-orange-900 border-orange-200 hover:from-amber-100 hover:to-orange-200{{end}}
                                {{if eq .Assignment.DecisionReason "Override"}}overridden{{end}}
                            {{end}}" 
                        data-date="{{.Date.Format "2006-01-02"}}" 
                        {{if .Assignment}}data-assignment-id="{{.Assignment.ID}}"{{end}}
                        aria-label="{{.Date.Format "January 2, 2006"}}{{if .Assignment}} - {{.Assignment.Parent}} assigned{{if eq .Assignment.DecisionReason "Override"}} - Locked (manually overridden){{end}}{{end}}">
                        <span class="block text-lg md:text-xl font-bold mb-1">{{.DayOfMonth}}</span>
                        {{if .Assignment}}
                        <span class="block text-xs md:text-sm font-semibold">{{.Assignment.Parent}}</span>
                        {{if .Assignment.DecisionReason}}
                        <span class="block text-xs text-slate-500 mt-1">{{.Assignment.DecisionReason}}</span>
                        {{end}}
                        {{end}}
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}
<!-- End Calendar Section -->

<!-- Confirmation Modal -->
<dialog id="unlock-modal" aria-labelledby="modal-title" class="backdrop:bg-gray-500 backdrop:bg-opacity-75 backdrop:transition-opacity rounded-lg shadow-xl p-0 max-w-lg w-full">
    <!-- Modal panel -->
    <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl sm:p-6">
        <div class="sm:flex sm:items-start">
            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
            </div>
            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Unlock Event</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" id="modal-description">
                        This event will be re-evaluated by the scheduler. Are you sure you want to unlock this assignment?
                    </p>
                </div>
            </div>
        </div>
        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
            <button type="button" id="modal-confirm"
                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:ml-3 sm:w-auto">
                Unlock Event
            </button>
            <button type="button" id="modal-cancel"
                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600 sm:mt-0 sm:w-auto">
                Cancel
            </button>
        </div>
    </div>
</dialog>
{{end}}

{{define "scripts"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to format date as YYYY-MM-DD (local timezone)
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const todayString = getLocalDateString(today);
        const todayCell = document.querySelector(`#assignment-calendar td[data-date="${todayString}"]`);

        if (todayCell) {
            // Add custom today-cell class for styling
            todayCell.classList.add('today-cell');
        }

        // Calendar interaction management
        const calendar = document.getElementById('assignment-calendar');
        if (calendar) {
            // Handle clicks on calendar
            calendar.addEventListener('click', function (e) {
                const cell = e.target.closest('td.overridden');

                // If clicked on an overridden cell, show unlock modal
                if (cell) {
                    e.stopPropagation();
                    const assignmentId = cell.dataset.assignmentId;
                    if (assignmentId) {
                        showUnlockModal(assignmentId);
                    }
                }
            });
        }

        // Modal management functions
        const modal = document.getElementById('unlock-modal');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        let currentAssignmentId = null;

        function showUnlockModal(assignmentId) {
            currentAssignmentId = assignmentId;
            modal.showModal();
            // Focus the confirm button for accessibility
            setTimeout(() => modalConfirm.focus(), 100);
        }

        function hideUnlockModal() {
            modal.close();
            currentAssignmentId = null;
        }

        function unlockAssignment() {
            if (currentAssignmentId) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/unlock';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'assignment_id';
                input.value = currentAssignmentId;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Modal event listeners
        if (modalCancel) {
            modalCancel.addEventListener('click', hideUnlockModal);
        }
        if (modalConfirm) {
            modalConfirm.addEventListener('click', function () {
                unlockAssignment();
                hideUnlockModal();
            });
        }

        // Close modal on backdrop click (clicking outside the dialog)
        if (modal) {
            modal.addEventListener('click', function (e) {
                const rect = modal.getBoundingClientRect();
                if (
                    e.clientX < rect.left ||
                    e.clientX > rect.right ||
                    e.clientY < rect.top ||
                    e.clientY > rect.bottom
                ) {
                    hideUnlockModal();
                }
            });
        }
    });
</script>
{{end}}